<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/css/style.css" />
    <title>Denúncia</title>
  </head>
  <body>
    <header class="mb-4">
      <div class="container d-flex align-items-center py-3">
        <a href="/Landing_page.html"
          ><img src="/img/nexassist.png" alt="Logo" width="60" height="60"
        /></a>
        <h1 class="ms-3" id="titu_1">Denúncia</h1>
      </div>
    </header>

    <main class="container">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card shadow-sm">
            <div class="card-body">
              <p class="text-center">
                Sua denúncia será enviada ao administrador para análise do
                perfil e do caso.
              </p>

              <div id="alertPlaceholder" style="display: none"></div>

              <form id="formDenuncia">
                <div class="mb-3">
                  <label for="email_denunciado" class="form-label"
                    >E-mail do denunciado</label
                  >
                  <input
                    type="email"
                    id="email_denunciado"
                    class="form-control"
                    placeholder="pessoa@exemplo.com"
                    required
                  />
                </div>

                <div class="mb-3">
                  <label for="motivo" class="form-label">Motivo</label>
                  <!-- motivo é um campo texto no banco, então usamos textarea -->
                  <textarea
                    id="motivo"
                    class="form-control"
                    rows="2"
                    placeholder="Descreva o motivo da denúncia"
                    required
                  ></textarea>
                </div>

                <div class="mb-3">
                  <label for="descricao" class="form-label"
                    >Descrição (detalhe o ocorrido)</label
                  >
                  <textarea
                    id="descricao"
                    class="form-control"
                    rows="4"
                    required
                  ></textarea>
                </div>

                <!-- opcional: id_evento -->
                <div class="mb-3" style="display: none">
                  <label for="id_evento" class="form-label"
                    >ID do evento (opcional)</label
                  >
                  <input
                    type="text"
                    id="id_evento"
                    class="form-control"
                    placeholder="123"
                  />
                </div>

                <div class="d-grid">
                  <button type="submit" class="btn btn-danger btn-lg">
                    Enviar Denúncia
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      function showAlert(message, type = "info") {
        const holder = document.getElementById("alertPlaceholder");
        holder.style.display = "block";
        holder.innerHTML = `<div class="alert alert-${type} alert-dismissible" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
      }

      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("formDenuncia");
        const token = localStorage.getItem("token");

        if (!token) {
          showAlert(
            'Você precisa estar logado para enviar uma denúncia. <a href="/login.html" class="alert-link">Login</a>',
            "warning"
          );
        }

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          if (!token) return;

          const email_denunciado = document
            .getElementById("email_denunciado")
            .value.trim();
          const motivo = document.getElementById("motivo").value;
          const descricao = document.getElementById("descricao").value.trim();
          const id_evento =
            document.getElementById("id_evento").value.trim() || null;

          if (!email_denunciado || !motivo) {
            showAlert("Preencha os campos obrigatórios.", "warning");
            return;
          }

          const payload = {
            email_denunciado,
            motivo,
            descricao,
          };

          if (id_evento) payload.id_evento = id_evento;

          try {
            showAlert("Enviando denúncia...", "info");

            const res = await fetch("/api/denuncias", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
              },
              body: JSON.stringify(payload),
            });

            const data = await res.json();

            if (res.ok) {
              showAlert("Denúncia enviada com sucesso.", "success");
              form.reset();
            } else {
              const msg =
                data && (data.erro || data.mensagem || JSON.stringify(data));
              showAlert(`Erro ao enviar denúncia: ${msg}`, "danger");
            }
          } catch (err) {
            console.error("Erro ao enviar denúncia:", err);
            showAlert("Erro de rede ao enviar denúncia.", "danger");
          }
        });
      });
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
