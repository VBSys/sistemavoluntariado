<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Consultas de Usuários</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <header class="navbar navbar-light bg-light px-3">
      <div
        class="container-fluid d-flex justify-content-between align-items-center"
      >
        <a class="navbar-brand" href="/denuncia.html">
          <img src="/img/nexassist.png" alt="Logo" width="50" height="50" />
        </a>
        <span id="perfilUsuario" class="fw-bold text-muted"
          >Verificando acesso...</span
        >
      </div>
    </header>

    <main class="container mt-5" id="main_page" style="display: none">
      <h2 class="mb-4">Consultas de Usuários</h2>

      <form id="formConsulta" class="row g-3 mb-4">
        <div class="col-md-4">
          <input
            type="text"
            class="form-control"
            id="nome_input"
            placeholder="Buscar por nome"
          />
        </div>
        <div class="col-md-4">
          <input
            type="email"
            class="form-control"
            id="email_input"
            placeholder="Buscar por e-mail"
          />
        </div>
        <div class="col-md-4">
          <button class="btn btn-dark w-100" type="submit">Buscar</button>
        </div>
      </form>

      <form id="formTodos" class="mb-4">
        <button class="btn btn-secondary" type="submit">
          Buscar todos os usuários
        </button>
      </form>

      <div
        id="mensagemErro"
        class="text-danger text-center mb-3"
        style="display: none"
      >
        Nenhum usuário encontrado.
      </div>

      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
          <thead class="table-dark">
            <tr>
              <th>Nome</th>
              <th>E-mail</th>
              <th>Perfil</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </main>

    <script>
      const formConsulta = document.getElementById("formConsulta");
      const formTodos = document.getElementById("formTodos");
      const tabelaBody = document.querySelector("tbody");
      const mensagemErro = document.getElementById("mensagemErro");
      const mainPage = document.getElementById("main_page");
      const perfilUsuario = document.getElementById("perfilUsuario");

      // Simulação de autenticação (substitua por token real)
      const usuarioLogado = { id_tipo: 3, nome: "Administrador" }; // id_tipo = 3 → admin
      const token = "SEU_TOKEN_AQUI"; // substitua pelo token real

      if (usuarioLogado.id_tipo === 3) {
        perfilUsuario.textContent = "Administrador";
        mainPage.style.display = "block";
      } else {
        perfilUsuario.textContent = "Acesso restrito";
        alert("Você não tem permissão para acessar esta página.");
      }

      function renderizarTabela(usuarios) {
        tabelaBody.innerHTML = "";

        if (!usuarios || usuarios.length === 0) {
          mensagemErro.style.display = "block";
          return;
        }

        mensagemErro.style.display = "none";

        usuarios.forEach((usuario) => {
          const linha = document.createElement("tr");
          linha.innerHTML = `
          <td>${usuario.nome_completo}</td>
          <td>${usuario.email}</td>
          <td>${
            usuario.id_tipo === 1
              ? "Voluntário"
              : usuario.id_tipo === 2
              ? "Beneficiário"
              : "Administrador"
          }</td>
          <td>
            ${
              usuarioLogado.id_tipo === 3
                ? `<button class="btn btn-danger btn-sm" onclick="excluirUsuario(${usuario.id_usuario})">Excluir</button>`
                : ""
            }
          </td>
        `;
          tabelaBody.appendChild(linha);
        });
      }

      async function excluirUsuario(id) {
        if (!confirm("Tem certeza que deseja excluir este usuário?")) return;

        try {
          const res = await fetch(`/api/admin/${id}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          const resultado = await res.json();

          if (res.ok) {
            alert("Usuário excluído com sucesso!");
            formTodos.dispatchEvent(new Event("submit")); // Recarrega a tabela
          } else {
            alert(resultado.erro || "Erro ao excluir usuário.");
          }
        } catch (err) {
          console.error("Erro ao excluir:", err);
          alert("Erro ao excluir usuário.");
        }
      }

      formConsulta.addEventListener("submit", async (e) => {
        e.preventDefault();
        const nome = document.getElementById("nome_input").value;
        const email = document.getElementById("email_input").value;

        const queryParams = new URLSearchParams();
        if (nome) queryParams.append("nome", nome);
        if (email) queryParams.append("email", email);

        try {
          const res = await fetch(
            `/api/admin/consultar?${queryParams.toString()}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          const data = await res.json();
          renderizarTabela(data.usuarios);
        } catch (err) {
          console.error("Erro ao buscar usuários:", err);
        }
      });

      formTodos.addEventListener("submit", async (e) => {
        e.preventDefault();
        try {
          const res = await fetch("/api/admin/todos", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          renderizarTabela(data.usuarios);
        } catch (err) {
          console.error("Erro ao buscar todos os usuários:", err);
        }
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
