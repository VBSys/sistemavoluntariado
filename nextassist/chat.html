<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Teste Chat Socket.io</title>
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        background: #f5f7fb;
        margin: 0;
        display: flex;
        height: 100vh;
      }
      .container {
        margin: auto;
        width: 100%;
        max-width: 800px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 80vh;
      }
      header {
        padding: 12px 16px;
        background: #2b6cb0;
        color: #fff;
        display: flex;
        gap: 12px;
        align-items: center;
      }
      header h1 {
        font-size: 16px;
        margin: 0;
      }
      #messages {
        flex: 1;
        padding: 16px;
        overflow: auto;
        background: linear-gradient(180deg, #eef5ff, #fff);
      }
      .msg {
        max-width: 70%;
        padding: 8px 12px;
        margin: 8px 0;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        word-wrap: break-word;
      }
      .msg.me {
        margin-left: auto;
        background: #d1fae5;
      }
      .msg.other {
        margin-right: auto;
        background: #fff;
        border: 1px solid #e6eef8;
      }
      .meta {
        font-size: 11px;
        color: #666;
        margin-bottom: 4px;
      }
      .composer {
        padding: 12px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 8px;
        align-items: center;
        background: #fafafa;
      }
      .composer input[type="text"] {
        flex: 1;
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #ddd;
      }
      .small {
        width: 80px;
      }
      button {
        padding: 8px 12px;
        border-radius: 6px;
        border: 0;
        cursor: pointer;
        background: #2b6cb0;
        color: #fff;
      }
      label {
        font-size: 12px;
        color: #333;
        margin-right: 6px;
      }
      .ids {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .hint {
        font-size: 12px;
        color: #666;
        margin-left: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Chat em tempo real — Teste</h1>
        <div class="hint">Conectando ao servidor socket.io</div>
      </header>

      <div id="messages" aria-live="polite"></div>

      <form id="form" class="composer" autocomplete="off">
        <div class="ids">
          <label for="remetente">Remetente</label>
          <input id="remetente" class="small" type="text" value="1" />
          <label for="destinatario">Dest.</label>
          <input id="destinatario" class="small" type="text" value="2" />
        </div>

        <input
          id="input"
          type="text"
          placeholder="Digite a mensagem..."
          required
        />
        <button type="submit">Enviar</button>
      </form>
    </div>

    <!-- cliente socket.io (servido pelo servidor) -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
      // util: escape para evitar XSS
      function escapeHtml(str) {
        if (!str && str !== 0) return "";
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // form elementos
      const form = document.getElementById("form");
      const input = document.getElementById("input");
      const messages = document.getElementById("messages");
      const remetenteInput = document.getElementById("remetente");
      const destinatarioInput = document.getElementById("destinatario");

      // conecta (usa mesmo host/origem)
      const socket = io();

      // quando conectar
      socket.on("connect", () => {
        appendSystem(`Conectado: ${socket.id}`);
      });

      // histórico de mensagens (enviado apenas ao novo cliente)
      socket.on("mensagensAntigas", (lista) => {
        // lista é um array com objetos: { id_remetente, id_destinatario, mensagem, data_envio }
        if (!Array.isArray(lista)) return;
        lista.forEach((item) => {
          appendMessage(
            item.id_remetente,
            item.id_destinatario,
            item.mensagem,
            item.data_envio
          );
        });
      });

      // nova mensagem enviada para todos
      socket.on("mensagem", (data) => {
        appendMessage(
          data.id_remetente,
          data.id_destinatario,
          data.mensagem,
          data.data_envio
        );
      });

      socket.on("disconnect", () => {
        appendSystem("Desconectado do servidor");
      });

      // enviar mensagem
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const id_remetente = remetenteInput.value.trim();
        const id_destinatario = destinatarioInput.value.trim();
        const mensagem = input.value.trim();
        if (!mensagem) return;
        // emitir para o servidor (seu socket.js vai inserir no DB e emitir para todos)
        socket.emit("mensagem", { id_remetente, id_destinatario, mensagem });
        input.value = "";
        input.focus();
        // opcional: você pode já adicionar localmente (servidor também emitirá)
        // appendMessage(id_remetente, id_destinatario, mensagem, new Date());
      });

      // helpers de exibição
      function appendSystem(text) {
        const el = document.createElement("div");
        el.style.textAlign = "center";
        el.style.fontSize = "12px";
        el.style.color = "#666";
        el.style.margin = "6px 0";
        el.textContent = text;
        messages.appendChild(el);
        scrollToBottom();
      }

      function appendMessage(
        id_remetente,
        id_destinatario,
        mensagem,
        data_envio
      ) {
        const myId = String(remetenteInput.value).trim();
        const isMe = String(id_remetente) === myId;

        const wrap = document.createElement("div");
        wrap.className = "msg " + (isMe ? "me" : "other");

        const meta = document.createElement("div");
        meta.className = "meta";
        const date = data_envio ? new Date(data_envio) : new Date();
        meta.textContent = `${
          isMe ? "Você" : "Usuário " + id_remetente
        } → ${id_destinatario} · ${formatDate(date)}`;

        const body = document.createElement("div");
        body.className = "body";
        body.innerHTML = escapeHtml(mensagem);

        wrap.appendChild(meta);
        wrap.appendChild(body);
        messages.appendChild(wrap);
        scrollToBottom();
      }

      function formatDate(d) {
        try {
          return d.toLocaleString();
        } catch (e) {
          return d.toString();
        }
      }

      function scrollToBottom() {
        messages.scrollTop = messages.scrollHeight;
      }
    </script>
  </body>
</html>
